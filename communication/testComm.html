<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>×‘×“×™×§×ª ××¢×¨×›×ª E2E - UserDB ×•-TaskDB</title>
</head>
<body>
    <h1>×‘×“×™×§×ª ××¢×¨×›×ª E2E - FAJAX, Network, Server, UserDB ×•-TaskDB</h1>

    <button onclick="runE2ETest()">×”×ª×—×œ ×‘×“×™×§×ª ××¢×¨×›×ª E2E</button>

    <script>
        // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ××¢×¨×›×ª ××œ××” E2E
        function runE2ETest() {
            console.log("ğŸš€ ××ª×—×™×œ×™× ×‘×“×™×§×ª ××¢×¨×›×ª E2E...");

            // × ×™×§×•×™ ×”-Local Storage ×œ×¤× ×™ ×”×ª×—×œ×ª ×”×‘×“×™×§×•×ª
            localStorage.clear();
            showLocalStorage();

            // 1. ×”×•×¡×¤×ª ××©×ª××© ×—×“×© ×œ-UserDB
            const addUserRequest = new FXMLHttpRequest();
            addUserRequest.open("POST", "/users");
            addUserRequest.setCallback(() => {
                if (addUserRequest.readyState === 4) {
                    console.log("âœ… ×©×œ×‘ 1: ××©×ª××© × ×•×¡×£ ×‘×”×¦×œ×—×”:", JSON.parse(addUserRequest.response));
                    showLocalStorage();

                    // 2. ×”×•×¡×¤×ª ××©×™××” ×—×“×©×” ×œ-TaskDB
                    const addTaskRequest = new FXMLHttpRequest();
                    addTaskRequest.open("POST", "/tasks");
                    addTaskRequest.setCallback(() => {
                        if (addTaskRequest.readyState === 4) {
                            console.log("âœ… ×©×œ×‘ 2: ××©×™××” × ×•×¡×¤×” ×‘×”×¦×œ×—×”:", JSON.parse(addTaskRequest.response));
                            showLocalStorage();

                            // 3. ×©×œ×™×¤×ª ×›×œ ×”××©×™××•×ª ×©×œ ×”××©×ª××© ×-TaskDB
                            const getTasksRequest = new FXMLHttpRequest();
                            getTasksRequest.open("GET", "/tasks");
                            getTasksRequest.setCallback(() => {
                                if (getTasksRequest.readyState === 4) {
                                    console.log("âœ… ×©×œ×‘ 3: ××©×™××•×ª × ×©×œ×¤×• ×‘×”×¦×œ×—×”:", JSON.parse(getTasksRequest.response));
                                    showLocalStorage();

                                    // 4. ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×”××©×ª××©
                                    const updateUserRequest = new FXMLHttpRequest();
                                    updateUserRequest.open("PUT", "/users");
                                    updateUserRequest.setCallback(() => {
                                        if (updateUserRequest.readyState === 4) {
                                            console.log("âœ… ×©×œ×‘ 4: ×¤×¨×˜×™ ×”××©×ª××© ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”:", JSON.parse(updateUserRequest.response));
                                            showLocalStorage();

                                            // 5. ×¢×“×›×•×Ÿ ×”××©×™××” ×‘-TaskDB
                                            const updateTaskRequest = new FXMLHttpRequest();
                                            updateTaskRequest.open("PUT", "/tasks");
                                            updateTaskRequest.setCallback(() => {
                                                if (updateTaskRequest.readyState === 4) {
                                                    console.log("âœ… ×©×œ×‘ 5: ×”××©×™××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”:", JSON.parse(updateTaskRequest.response));
                                                    showLocalStorage();

                                                    // 6. ××—×™×§×ª ×”××©×ª××© ×-UserDB
                                                    const deleteUserRequest = new FXMLHttpRequest();
                                                    deleteUserRequest.open("DELETE", "/users");
                                                    deleteUserRequest.setCallback(() => {
                                                        if (deleteUserRequest.readyState === 4) {
                                                            console.log("âœ… ×©×œ×‘ 6: ××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”:", JSON.parse(deleteUserRequest.response));
                                                            showLocalStorage();

                                                            // 7. ××—×™×§×ª ×”××©×™××” ×-TaskDB
                                                            const deleteTaskRequest = new FXMLHttpRequest();
                                                            deleteTaskRequest.open("DELETE", "/tasks");
                                                            deleteTaskRequest.setCallback(() => {
                                                                if (deleteTaskRequest.readyState === 4) {
                                                                    console.log("âœ… ×©×œ×‘ 7: ××©×™××” × ××—×§×” ×‘×”×¦×œ×—×”:", JSON.parse(deleteTaskRequest.response));
                                                                    showLocalStorage();

                                                                    // 8. ×‘×“×™×§×” ×¡×•×¤×™×ª ×©×œ ×”-Local Storage
                                                                    console.log("ğŸ” ×‘×“×™×§×” ×‘-Local Storage ×œ××—×¨ ×›×œ ×”×‘×“×™×§×•×ª:");
                                                                    showLocalStorage();
                                                                }
                                                            });
                                                            deleteTaskRequest.send(JSON.stringify({ id: 1 }));
                                                        }
                                                    });
                                                    deleteUserRequest.send(JSON.stringify({ userName: "charlie" }));
                                                }
                                            });
                                            updateTaskRequest.send(JSON.stringify({
                                                id: 1,
                                                title: "Update project",
                                                desc: "Updated the app",
                                                priority: "high",
                                                category: "work",
                                                status: true
                                            }));
                                        }
                                    });
                                    updateUserRequest.send(JSON.stringify({
                                        userName: "charlie",
                                        email: "charlie@updated.com",
                                        password: "newpassword"
                                    }));
                                }
                            });
                            getTasksRequest.send(JSON.stringify({ userName: "charlie" }));
                        }
                    });
                    addTaskRequest.send(JSON.stringify({
                        title: "Complete project",
                        desc: "Finalize the app",
                        userName: "charlie",
                        priority: "medium",
                        category: "studies",
                        status: false
                    }));
                }
            });

            addUserRequest.send(JSON.stringify({
                userName: "charlie",
                email: "charlie@example.com",
                password: "mypassword"
            }));
        }

        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”××™×“×¢ ×”× ××¦× ×‘-Local Storage
        function showLocalStorage() {
            console.log("ğŸ” Local Storage Status:");
            console.log("ğŸ‘¤ ××©×ª××©×™×:", JSON.parse(localStorage.getItem("users")) || []);
            console.log("ğŸ“ ××©×™××•×ª:", JSON.parse(localStorage.getItem("tasks")) || []);
        }
    </script>

    <!-- × ×ª×™×‘×™× × ×›×•× ×™× ×œ×§×‘×¦×™ ×”×¡×§×¨×™×¤×˜×™× -->
    <script src="../server/dataBase/userDB.js"></script>
    <script src="../server/dataBase/taskDB.js"></script>
    <script src="../server/server.js"></script>
    <script src="../communication/network.js"></script>
    <script src="../communication/FXMLHttpRequest.js"></script>

</body>
</html>
